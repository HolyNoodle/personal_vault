global
    maxconn 4096
    log stdout format raw local0

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout tunnel 3600s  # 1 hour for WebRTC

frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/sandbox.pem
    
    # Redirect HTTP to HTTPS
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    
    # Route to backend (serves both API and static files)
    default_backend backend

backend backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server backend1 backend:8080 check inter 5s fall 3 rise 2

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
